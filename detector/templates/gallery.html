<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery - Goober Detector</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }
        
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .back-link {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background-color: #007bff;
            color: white;
        }
        
        .photo-count {
            color: #666;
            font-size: 1.1em;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .photo-card {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .photo-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        
        .photo-info {
            padding: 15px;
        }
        
        .photo-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .photo-meta {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        
        .photo-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            flex: 1;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .delete-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .empty-gallery {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-gallery h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Photo Gallery</h1>
        
        <div class="header-actions">
            <a href="." class="back-link">‚Üê Back to Detector</a>
            <div class="photo-count" id="photo-count">Loading photos...</div>
        </div>
        
        <div id="message-container"></div>
        
        <div id="gallery-container">
            <div class="loading">Loading photos...</div>
        </div>
    </div>

    <script>
        // Get the base path (e.g., '/pr-42/' or '/')
        function getBasePath() {
            const path = window.location.pathname;
            // If we're in a lookaside instance (path starts with /pr-), extract the base path
            const match = path.match(/^(\/pr-\d+)/);
            if (match) {
                return match[1] + '/';
            }
            return '/';
        }
        
        const basePath = getBasePath();
        
        function showMessage(text, isError = false) {
            const container = document.getElementById('message-container');
            const message = document.createElement('div');
            message.className = `message ${isError ? 'error' : 'success'}`;
            message.textContent = text;
            container.innerHTML = '';
            container.appendChild(message);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
        }
        
        function loadPhotos() {
            fetch(`${basePath}api/photos`)
                .then(response => response.json())
                .then(photos => {
                    const container = document.getElementById('gallery-container');
                    const countElement = document.getElementById('photo-count');
                    
                    if (photos.length === 0) {
                        container.innerHTML = `
                            <div class="empty-gallery">
                                <h2>No photos yet</h2>
                                <p>Go back to the detector and save some photos!</p>
                            </div>
                        `;
                        countElement.textContent = 'No photos saved';
                        return;
                    }
                    
                    countElement.textContent = `${photos.length} photo${photos.length === 1 ? '' : 's'} saved`;
                    
                    container.innerHTML = `
                        <div class="gallery">
                            ${photos.map(photo => `
                                <div class="photo-card" data-photo-id="${photo.id}">
                                    <img src="${basePath}photos/${photo.filename}" alt="Saved photo" class="photo-image" 
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'250\'%3E%3Crect fill=\'%23ddd\' width=\'300\' height=\'250\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EImage not found%3C/text%3E%3C/svg%3E'">
                                    <div class="photo-info">
                                        <h3>Photo ${photo.id}</h3>
                                        <div class="photo-meta">
                                            <strong>Faces detected:</strong> ${photo.face_count}
                                        </div>
                                        <div class="photo-meta">
                                            <strong>Saved:</strong> ${new Date(photo.saved_at).toLocaleString()}
                                        </div>
                                        <div class="photo-actions">
                                            <button class="delete-btn" onclick="deletePhoto(${photo.id}, this)">
                                                üóëÔ∏è Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading photos:', error);
                    document.getElementById('gallery-container').innerHTML = `
                        <div class="empty-gallery">
                            <h2>Error loading photos</h2>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                });
        }
        
        function deletePhoto(photoId, button) {
            if (!confirm('Are you sure you want to delete this photo?')) {
                return;
            }
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Deleting...';
            
            fetch(`${basePath}api/delete_photo/${photoId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('Error: ' + data.error, true);
                        button.disabled = false;
                        button.textContent = originalText;
                    } else {
                        showMessage('Photo deleted successfully');
                        // Remove the photo card from the DOM
                        const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
                        if (photoCard) {
                            photoCard.style.transition = 'opacity 0.3s, transform 0.3s';
                            photoCard.style.opacity = '0';
                            photoCard.style.transform = 'scale(0.9)';
                            setTimeout(() => {
                                photoCard.remove();
                                // Reload to update count
                                loadPhotos();
                            }, 300);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error deleting photo:', error);
                    showMessage('Error deleting photo. Please try again.', true);
                    button.disabled = false;
                    button.textContent = originalText;
                });
        }
        
        // Load photos when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPhotos();
        });
    </script>
</body>
</html>

